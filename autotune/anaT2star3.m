function [d, dd] = anaT2star2(files, frames, pulse, refpulse, cntrl)% anaT2star3(files, last, pulse, refpulse)global awgdata;    data = [];if ~iscell(files)    files = cellstr(files);endfor i = 1:length(files)    d = load(files{i}, 'data', 'scan');    data = cat(1, data, d.data{1});endif nargin < 2 || isempty(frames)    frames = 1:find(isfinite(data(:, end, end)), 1, 'last');endcut = 10; % ignore data points before this one.if nargin < 3 || isempty(pulse)    pulse = 1:size(data, 2)/2;endif nargin < 4 || isempty(refpulse)    refpulse = pulse(1);endif length(refpulse) == 1    refpulse = repmat(refpulse, size(pulse));endif nargin < 5    cntrl = '';endif ~isstr(cntrl)    offset = cntrl;    cntrl = '';else    offset = 0;endnpulse = length(pulse);if isfield(d.scan, 'data') && isfield(d.scan.data, 'pulses')    dt = awgdata.xval(d.scan.data.pulses(pulse));    dt(isnan(dt)) = -1;else            %dt = [ 0 0:1e-3:40e-3 [ 0 0e-3:1e-3:10e-3 12e-3 15e-3:3e-3:21e-3 25e-3:5e-3:50e-3, .06:.01:.1 .12:.02:.2 .23:.03:.5 .55:.05:1]+0.041]*1e3;    %dt = [0 0e-3:1e-3:30e-3 35e-3:5e-3:50e-3, .06:.01:.1 .12:.02:.2 .23:.03:.5 .55:.05:1]*1e3;    %dt = [0 0e-3:1e-3:20e-3 22e-3:2e-3:30e-3 35e-3:5e-3:50e-3, .06:.01:.1 .12:.02:.2 .23:.03:.5 .55:.05:1]*1e3;    %dt=[0 0:0.8e-3:20e-3 [0 0:0.4e-3:20e-3]+20e-3 [0 0:0.2e-3:10e-3]+40e-3  [0 0:0.4e-3:20e-3]+50e-3 [0 0:0.8e-3:40e-3]+70e-3];    dt = 1:length(pulse);    dt = dt(1:min(npulse, end));    dt(end+1:npulse) = nan;end% average time in each framemST = permute(mean(data(frames, 1:2:end, :), 2), [1 3 2]);% average over valid times.mT2 = mean(data(frames, 2:2:end, cut:end), 3);% average framesm2 = mean(mT2(:, pulse), 1);r2 = mean(mT2(:, refpulse), 1);x = linspace(d.scan.loops(1).rng(1), d.scan.loops(1).rng(2), d.scan.loops(1).npoints);brk = [0 find(dt(2:end) < dt(1:end-1))];brk(end+1) = length(dt);c = 'rgbcmyk';figure(3);clfhold on;for i = 1:length(brk)-1    rng = brk(i)+1:brk(i+1);    plot(dt(rng), m2(rng)-r2(rng)+(i-1)*offset, ['.-', c(mod(i-1, 7)+1)]);endxlabel('\tau_M (ns)');ylabel('V_{QPC}')%title(''); %differencefprintf('%d tau_M sweeps averaged\n', length(frames));figure(4)%subplot(211)imagesc(mT2) %m-r%imagesc(abs(fft(m-r, [], 2)))xlabel('\tau_M (ns)')   %('pulse No.')ylabel('sweep No.')figure(5);imagesc(x, frames, mST);figure(6);plot(x, mean(mST, 1));
